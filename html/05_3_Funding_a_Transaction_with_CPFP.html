<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>05_3_Funding_a_Transaction_with_CPFP</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="funding-a-transaction-with-cpfp">5.3: Funding a Transaction with
CPFP</h1>
<p>If your Bitcoin transaction is stuck, and you’re the
<em>recipient</em>, you can clear it using CPFP (child-pays-for-parent).
This is alternative to the <em>sender’s</em> ability to do so with
RBF.</p>
<blockquote>
<p>:warning: <strong>VERSION WARNING:</strong> This is an innovation
from Bitcoin Core v 0.13.0, which again means that most people should be
using it by now.</p>
</blockquote>
<h2 id="understand-how-cpfp-works">Understand How CPFP Works</h2>
<p>RBF was all about the sender. He messed up and needed to increase the
fee, or he wanted to be smart and combine transactions for a variety of
reasons. It was a powerful sender-oriented feature. In some ways, CPFP
is RBF’s opposite, because it empowers the recipient who knows that his
money hasn’t arrived yet and wants to speed it up. However, it’s also a
much simpler feature, with less wide applicability.</p>
<p>Basically, the idea of CPFP is that a recipient has a transaction
that hasn’t been confirmed in a block that he wants to spend. So, he
includes that unconfirmed transaction in a new transaction and pays a
high-enough fee to encourage a miner to include both the original
(parent) transaction and the new (child) transaction in a block. As a
result, the parent and child transactions clear simultaneously.</p>
<p>It should be noted that CPFP is not a new protocol feature, like RBF.
It’s just a new incentivization scheme that can be used for transaction
selection by miners. This also means that it’s not as reliable as a
protocol change like RBF: there might be reasons that the child is not
selected to be put into a block, and that will prevent the parent from
ever being put into a block.</p>
<h2 id="spend-unconfirmed-utxos">Spend Unconfirmed UTXOs</h2>
<p>Funding a transaction with CPFP is a very simple process using the
methods you’re already familiar with:</p>
<ol type="1">
<li>Find the <code>txid</code> and <code>vout</code> of the unconfirmed
transaction. This may be the trickiest part, as <code>bitcoin-cli</code>
generally tries to protect you from unconfirmed transactions. The sender
might be able to send you this info; even with just the
<code>txid</code>, you should be able to figure out the
<code>vout</code> in a blockchain explorer.</li>
</ol>
<p>You do have one other option: use
<code>bitcoin-cli getrawmempool</code>, which can be used to list the
contents of your entire mempool, where the unconfirmed transactions will
be. You may have to dig through several if the mempool is particularly
busy. You can then get more information on a specific transaction with
<code>bitcoin-cli getrawtransaction</code> with the verbose flag set to
<code>true</code>: ``` $ bitcoin-cli getrawmempool [
“95d51e813daeb9a861b2dcdddf1da8c198d06452bbbecfd827447881ff79e061”]</p>
<p>$ bitcoin-cli getrawtransaction
95d51e813daeb9a861b2dcdddf1da8c198d06452bbbecfd827447881ff79e061 true {
“txid”:
“95d51e813daeb9a861b2dcdddf1da8c198d06452bbbecfd827447881ff79e061”,
“hash”:
“9729e47b8aee776112a82cec46df7638d112ca51856c53e238a9b1f7af3be4ce”,
“version”: 2, “size”: 247, “vsize”: 166, “weight”: 661, “locktime”:
1773277, “vin”: [ { “txid”:
“7a0178472300247d423ac4a04ff9165fa5b944104f6d6f9ebc557c6d207e7524”,
“vout”: 0, “scriptSig”: { “asm”:
“0014334f3a112df0f22e743ad97eec8195a00faa59a0”, “hex”:
“160014334f3a112df0f22e743ad97eec8195a00faa59a0” }, “txinwitness”: [
“304402207966aa87db340841d76d3c3596d8b4858e02aed1c02d87098dcedbc60721d8940220218aac9d728c9a485820b074804a8c5936fa3145ce68e24dcf477024b19e88ae01”,
“03574b1328a5dc2d648498fc12523cdf708efd091c28722a422d122f8a0db8daa9” ],
“sequence”: 4294967294 } ], “vout”: [ { “value”: 0.01000000, “n”: 0,
“scriptPubKey”: { “asm”: “OP_HASH160
f079f77f2ef0ef1187093379d128ec28d0b4bf76 OP_EQUAL”, “hex”:
“a914f079f77f2ef0ef1187093379d128ec28d0b4bf7687”, “reqSigs”: 1, “type”:
“scripthash”, “addresses”: [ “2NFAkGiwnp8wvCodRBx3smJwxncuG3hndn5” ] }
}, { “value”: 0.02598722, “n”: 1, “scriptPubKey”: { “asm”: “OP_HASH160
8799be12fb9eae6644659d95b9602ddfbb4b2aff OP_EQUAL”, “hex”:
“a9148799be12fb9eae6644659d95b9602ddfbb4b2aff87”, “reqSigs”: 1, “type”:
“scripthash”, “addresses”: [ “2N5cDPPuCTtYq13oXw8RfpY9dHJW8sL64U2” ] } }
], “hex”:
“0200000000010124757e206d7c55bc9e6f6d4f1044b9a55f16f94fa0c43a427d2400234778017a0000000017160014334f3a112df0f22e743ad97eec8195a00faa59a0feffffff0240420f000000000017a914f079f77f2ef0ef1187093379d128ec28d0b4bf768742a727000000000017a9148799be12fb9eae6644659d95b9602ddfbb4b2aff870247304402207966aa87db340841d76d3c3596d8b4858e02aed1c02d87098dcedbc60721d8940220218aac9d728c9a485820b074804a8c5936fa3145ce68e24dcf477024b19e88ae012103574b1328a5dc2d648498fc12523cdf708efd091c28722a422d122f8a0db8daa9dd0e1b00”
}</p>
<pre><code>Look through the `vout` array. Find the object that matches your address. (Here, it&#39;s the only one.) The `n` value is your `vout`. You now have everything you need to create a new CPFP transaction.</code></pre>
<p>$ utxo_txid=2NFAkGiwnp8wvCodRBx3smJwxncuG3hndn5 $ utxo_vout=0 $
recipient2=$(bitcoin-cli getrawchangeaddress)</p>
<pre><code>
   2. Create a raw transaction using your unconfirmed transaction as an input.
   3. Double the transaction fees (or more).
   
When you take these steps, everything should look totally normal, despite the fact that you&#39;re working with an unconfirmed transaction. To verify that all was well, we even looked at the results of our signature before we saved off the information to a variable:</code></pre>
<p>$ rawtxhex=<span class="math inline">$(bitcoin-cli -named
createrawtransaction inputs='''[ { "txid": "'$</span>utxo_txid’“,”vout”:
‘<span class="math inline">$utxo_vout' } ]''' outputs='''{
"'$</span>recipient2’“: 0.03597 }’’’)</p>
<p>$ bitcoin-cli -named signrawtransaction hexstring=$rawtxhex | jq -r
‘.hex’
02000000012b137ef780666ba214842ff6ea2c3a0b36711bcaba839c3710f763e3d9687fed000000006a473044022003ca1f6797d781ef121ba7c2d1d41d763a815e9dad52aa8bc5ea61e4d521f68e022036b992e8e6bf2c44748219ca6e0056a88e8250f6fd0794dc69f79a2e8993671601210317b163ab8c8862e09c71767112b828abd3852e315441893fa0f535de4fa39b8dffffffff01905abd07000000001976a91450b1d90a130c4f3f1e5fbfa7320fd36b7265db0488ac00000000</p>
<p>$ signedtx=<span
class="math inline">(<em>b</em><em>i</em><em>t</em><em>c</em><em>o</em><em>i</em><em>n</em> − <em>c</em><em>l</em><em>i</em> − <em>n</em><em>a</em><em>m</em><em>e</em><em>d</em><em>s</em><em>i</em><em>g</em><em>n</em><em>r</em><em>a</em><em>w</em><em>t</em><em>r</em><em>a</em><em>n</em><em>s</em><em>a</em><em>c</em><em>t</em><em>i</em><em>o</em><em>n</em><em>h</em><em>e</em><em>x</em><em>s</em><em>t</em><em>r</em><em>i</em><em>n</em><em>g</em>=</span>rawtxhex
| jq -r ‘.hex’) $ bitcoin-cli -named sendrawtransaction
hexstring=$signedtx
6a184a2f07fa30189f4831d6f041d52653a103b3883d2bec2f79187331fd7f0e ```</p>
<ol start="4" type="1">
<li>Crossing your fingers is not needed. You have verified your data is
correct. From this point on, things are out of your hands.</li>
</ol>
<p>Your transactions may go through quickly. They may not. It all
depends on whether the miners who are randomly generating the current
blocks have the CPFP patch or not. But you’ve given your transactions
the best chance.</p>
<p>That’s really all there is to it.</p>
<h3 id="be-aware-of-nuances">Be Aware of Nuances</h3>
<p>Though CPFP is usually described as being about a recipient using a
new transaction to pay for an old one that hasn’t been confirmed,
there’s nuance to this.</p>
<p>A <em>sender</em> could use CPFP to free up a transaction if he
received change from it. He would just use that change as his input, and
the resultant use of CPFP would free up the entire transaction. Mind
you, he’d do better to use RBF as long as it was enabled, as the total
fees would then be lower.</p>
<p>A <em>recipient</em> could use CPFP even if he wasn’t planning on
immediately spending the money, for example if he’s worried that the
funds may not be resent if the transaction expires. In this case, he
just creates a child transaction that sends all the money (minus a
transaction fee) to a change address. That’s what we did in our example,
above.</p>
<h2 id="summary-funding-a-transaction-with-cpfp">Summary: Funding a
Transaction with CPFP</h2>
<p>You can take advantage of the CPFP incentives to free up funds that
have been sent to you but have not been confirmed. Just use the
unconfirmed transaction as UTXO and pay a higher-than-average
transaction fee.</p>
<blockquote>
<p>:fire: <strong><em>What is the power of CPFP?</em></strong> Mostly,
CPFP is just useful to get funds unstuck when you’re the recipient and
the sender isn’t being helpful for whatever reason. It doesn’t have the
more powerful possibilities of RBF, but is an alternatve way to exert
control over a transaction after it’s been placed in the mempool, but
before it’s confirmed in a block.</p>
</blockquote>
<h2 id="whats-next">What’s Next?</h2>
<p>Advance through “bitcoin-cli” with <a
href="06_0_Expanding_Bitcoin_Transactions_Multisigs.md">Chapter Six:
Expanding Bitcoin Transactions with Multisigs</a>.</p>
</body>
</html>
