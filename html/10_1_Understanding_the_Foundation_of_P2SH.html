<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>10_1_Understanding_the_Foundation_of_P2SH</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="understanding-the-foundation-of-p2sh">10.1: Understanding the
Foundation of P2SH</h1>
<p>You know that Bitcoin Scripts can be used to control the redemption
of UTXOs. The next step is creating Scripts of your own … but that
requires a very specific technique.</p>
<h2 id="know-the-bitcoin-standards">Know the Bitcoin Standards</h2>
<p>Here’s the gotcha for using Bitcoin Scripts: for security reasons,
most Bitcoin nodes will only accept six types of “standard” Bitcoin
transactions.</p>
<ul>
<li><strong>Pay to Public Key (P2PK)</strong> — An older, deprecated
transaction (<code>&lt;pubKey&gt; OP_CHECKSIG</code>) that has been
replaced by the better security of P2PKH.</li>
<li><strong>Pay to Public Key Hash (P2PKH)</strong> — A standard
transaction
(<code>OP_DUP OP_HASH160 &lt;pubKeyHash&gt; OP_EQUALVERIFY OP_CHECKSIG</code>)
that pays to the hash of a public key.</li>
<li><strong>Pay to Witness Public Key hash (P2WPKH)</strong> — The
newest sort of public-key transaction. It’s just
(<code>OP_0 &lt;pubKeyHash&gt;</code>) because it depends on miner
consensus to work, as described in <a
href="09_5_Scripting_a_P2WPKH.md">§9.5</a>.</li>
<li><strong>Multisig</strong> — A transaction for a group of keys, as
explained more fully in <a
href="10_4_Scripting_a_Multisig.md">§10.4</a>.</li>
<li><strong>Null Data</strong> — An unspendable transaction
(<code>OP_RETURN Data</code>).</li>
<li><strong>Pay to Script Hash (P2SH)</strong> — A transaction that pays
out to a specific script, as explained more fully here.</li>
</ul>
<p>So how do you write a more complex Bitcoin Script? The answer is in
that last sort of standard transaction, the P2SH. You can put any sort
of long and complex script into a P2SH transaction, and as long as you
follow the standard rules for embedding your script and for redeeming
the funds, you’ll get the full benefits of Bitcoin Scripting.</p>
<blockquote>
<p>:warning: <strong>VERSION WARNING:</strong> Arbitrary P2SH scripts
only became standard as of Bitcoin Core 0.10.0. Before that, only P2SH
Multisigs were allowed.</p>
</blockquote>
<h2 id="understand-the-p2sh-script">Understand the P2SH Script</h2>
<p>You already saw a P2SH transaction when you created a multisig in <a
href="06_1_Sending_a_Transaction_to_a_Multisig.md">§6.1: Sending a
Transaction to a Multisig</a>. Though multisig is one of the standard
transaction types, <code>bitcoin-cli</code> simplifies the usage of its
multisigs by embedding them into P2SH transactions, as described more
fully in <a href="10_4_Scripting_a_Multisig.md">§10.4: Scripting a
Multisig</a>.</p>
<p>So, let’s look one more time at the <code>scriptPubKey</code> of that
P2SH multisig:</p>
<pre><code>      &quot;scriptPubKey&quot;: {
        &quot;asm&quot;: &quot;OP_HASH160 a5d106eb8ee51b23cf60d8bd98bc285695f233f3 OP_EQUAL&quot;,
        &quot;hex&quot;: &quot;a914a5d106eb8ee51b23cf60d8bd98bc285695f233f387&quot;,
        &quot;reqSigs&quot;: 1,
        &quot;type&quot;: &quot;scripthash&quot;,
        &quot;addresses&quot;: [
          &quot;2N8MytPW2ih27LctLjn6LfLFZZb1PFSsqBr&quot;
        ]
      }</code></pre>
<p>The locking script is quite simple looking:
<code>OP_HASH160 a5d106eb8ee51b23cf60d8bd98bc285695f233f3 OP_EQUAL</code>.
As usual, there’s a big chunk of data in the middle. This is a hash of
another, hidden locking script (<code>redeemScript</code>) that will
only be revealed when the funds are redeemed. In other words, the
standard locking script for a P2SH address is:
<code>OP_HASH160 &lt;redeemScriptHash&gt; OP_EQUAL</code>.</p>
<blockquote>
<p>:book: <strong><em>What is a redeemScript?</em></strong> Each P2SH
transaction carries the fingerprint of a hidden locking script within it
as a 20-byte hash. When a P2SH transaction is redeemed, the full
(unhashed) <code>redeemScript</code> is included as part of the
<code>scriptSig</code>. Bitcoin will make sure the
<code>redeemScript</code> matches the hash; then it actually runs the
<code>redeemScript</code> to see if the funds can be spent (or not).</p>
</blockquote>
<p>One of the interesting elements of P2SH transactions is that neither
the sender nor the Blockchain actually knows what the
<code>redeemScript</code> is! A sender just sends to a standardized P2SH
address marked with a “2” prefix and they don’t worry about how the
recipient is going to retrieve the funds at the end.</p>
<blockquote>
<p>:link: <strong>TESTNET vs MAINNET:</strong> on testnet, the prefix
for P2SH addresses is <code>2</code>, while on mainnet, it’s
<code>3</code>.</p>
</blockquote>
<h2 id="understand-how-to-build-a-p2sh-script">Understand How to Build a
P2SH Script</h2>
<p>Since the visible locking script for a P2SH transaction is so simple,
creating a transaction of this sort is quite simple too. In theory. All
you need to do is create a transaction whose locking script includes a
20-byte hash of the <code>redeemScript</code>. That hashing is done with
Bitcoin’s standard <code>OP_HASH160</code>.</p>
<blockquote>
<p>:book: <strong><em>What is OP_HASH160?</em></strong> The standard
hash operation for Bitcoin performs a SHA-256 hash, then a RIPEMD-160
hash.</p>
</blockquote>
<p>Overall, four steps are required:</p>
<ol type="1">
<li>Create an arbitrary locking script with Bitcoin Script.</li>
<li>Create a serialized version of that locking script.</li>
<li>Perform a SHA-256 hash on those serialized bytes.</li>
<li>Perform a RIPEMD-160 hash on the results of that SHA-256 hash.</li>
</ol>
<p>Each of those steps of course takes some work on its own, and some of
them can be pretty intricate. The good news is that you don’t really
have to worry about them, because they’re sufficiently complex that
you’ll usually have an API take care of it all for you.</p>
<p>So for now, we’ll just provide you with an overview, so that you
understand the general methodology. In <a
href="10_2_Building_the_Structure_of_P2SH.md">§10.2: Building the
Structure of P2SH</a> we’ll provide a more in-depth look at script
creation, in case you ever want to understand the guts of this
process.</p>
<h2 id="understand-how-to-send-a-p2sh-script-transaction">Understand How
to Send a P2SH Script Transaction</h2>
<p>So how do you actually send your P2SH transaction? Again, the theory
is very simple:</p>
<ol type="1">
<li>Embed your hash in a
<code>OP_HASH160 &lt;redeemScriptHash&gt; OP_EQUAL</code> script.</li>
<li>Translate that into hexcode.</li>
<li>Use that hex as your <code>scriptPubKey</code>.</li>
<li>Create the rest of the transaction.</li>
</ol>
<p>Unfortunately, this is another place where you’re going to need to
fall back to APIs, in large part because <code>bitcoin-cli</code>
doesn’t provide any support for creating P2SH transactions. (It can
redeem them just fine.)</p>
<h2 id="understand-how-to-unlock-a-p2sh-script-transaction">Understand
How to Unlock a P2SH Script Transaction</h2>
<p>The trick to redeeming a P2SH transaction is that the recipient must
have saved the secret serialized locking script that was hashed to
create the P2SH address. This is called a <code>redeemScript</code>
because it’s what the recipient needs to redeem his funds.</p>
<p>An unlocking <code>scriptSig</code> for a P2SH transaction is formed
as: <code>... data ... &lt;redeemScript&gt;</code>. The
<code>data</code> must <em>solely</em> be data that is pushed onto the
stack, not operators. (<a
href="https://github.com/bitcoin/bips/blob/master/bip-0016.mediawiki">BIP
16</a> calls them signatures, but that’s not an actual requirement.)</p>
<blockquote>
<p>:warning: <strong>WARNING:</strong> Though signatures are not a
requirement, a P2SH script actually isn’t very secure if it doesn’t
require at least one signature in its inputs. The reasons for this are
described in <a href="13_1_Writing_Puzzle_Scripts.md">§13.1: Writing
Puzzle Scripts</a>.</p>
</blockquote>
<p>When a UTXO is redeemed, it runs in two rounds of verification:</p>
<ol type="1">
<li>First, the <code>redeemScript</code> in the <code>scriptSig</code>
is hashed and compared to the hashed script in the
<code>scriptPubKey</code>.</li>
<li>If they match, then a second round of verification begins.</li>
<li>Second, the <code>redeemScript</code> is run using the prior data
that was pushed on the stack.</li>
<li>If that second round of verification <em>also</em> succeeds, the
UTXO is unlocked.</li>
</ol>
<p>Whereas you can’t easily create a P2SH transaction without an API,
you should be able to easily redeem a P2SH transaction with
<code>bitcoin-cli</code>. In fact, you already did in <a
href="06_2_Spending_a_Transaction_to_a_Multisig.md">§6.2: Sending a
Transaction to a Multisig</a>. The exact process is described in <a
href="10_6_Spending_a_P2SH_Transaction.md">§10.6: Spending a P2SH
Transaction</a>, after we’ve finished with all the intricacies of P2SH
transaction creation.</p>
<blockquote>
<p>:warning: <strong>WARNING:</strong> You can create a perfectly valid
transaction with a correcly hashed redeemScript, but if the redeemScript
doesn’t run, or doesn’t run correctly, your funds are lost forever.
That’s why it is so important to test your Scripts, as discussed in <a
href="09_3_Testing_a_Bitcoin_Script.md">§9.3: Testing a Bitcoin
Script</a>.</p>
</blockquote>
<h2 id="summary-understanding-the-foundation-of-p2sh">Summary:
Understanding the Foundation of P2SH</h2>
<p>Arbitrary Bitcoin Scripts are non-standard in Bitcoin. However, you
can incorporate them into standard transactions by using the P2SH
address type. You just hash your script as part of the locking script,
then you reveal and run it as part of the unlocking script. As long as
you can also satisfy the <code>redeemScript</code>, the UTXO can be
spent.</p>
<blockquote>
<p>:fire: <strong><em>What is the power of P2SH?</em></strong> You
already know the power of Bitcoin Script, which allows you to create
more complex Smart Contracts of all sorts. P2SH is what actually
unleashes that power by letting you include arbitrary Bitcoin Script in
standard Bitcoin transactions.</p>
</blockquote>
<h2 id="whats-next">What’s Next?</h2>
<p>Continue “Embedding Bitcoin Scripts” with <a
href="10_2_Building_the_Structure_of_P2SH.md">§10.2: Building the
Structure of P2SH</a>.</p>
</body>
</html>
