<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>09_1_Understanding_the_Foundation_of_Transactions</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="understanding-the-foundation-of-transactions">9.1: Understanding
the Foundation of Transactions</h1>
<p>The foundation of Bitcoin is the ability to protect transactions,
something that’s done with a simple scripting language.</p>
<h2 id="know-the-parts-of-the-cryptographic-puzzle">Know the Parts of
the Cryptographic Puzzle</h2>
<p>As described in <a href="01_0_Introduction.md">Chapter 1</a>, the
funds in each Bitcoin transaction are locked with a cryptographic
puzzle. To be precise, we said that Bitcoin is made up of “a sequence of
atomic transactions”. We noted that: “Each transaction is authenticated
by a sender with the solution to a previous cryptographic puzzle that
was stored as a script. The new transaction is locked for the recipient
with a new cryptographic puzzle that is also stored as a script.” Those
scripts, which lock and unlock transactions, are written in Bitcoin
Script.</p>
<blockquote>
<p>:book: <strong><em>What is Bitcoin Script?</em></strong> Bitcoin
Script is a stack-based Forth-like language that purposefully avoids
loops and so is not Turing-complete. It’s made up of individual opcodes.
Every single transaction in Bitcoin is locked with a Bitcoin Script;
when the locking transaction for a UTXO is run with the correct inputs,
that UTXO can then be spent.</p>
</blockquote>
<p>The fact that transactions are locked with scripts means that they
can be locked in a variety of different ways, requiring a variety of
different keys. In fact, we’ve met a number of different locking
mechanisms to date, each of which used different opcodes:</p>
<ul>
<li>OP_CHECKSIG, which checks a public key against a signature, is the
basis of the classic P2PKH address, as will be fully detailed in <a
href="09_4_Scripting_a_P2PKH.md">§9.3: Scripting a P2PKH</a>.</li>
<li>OP_CHECKMULTISIG similarly checks multisigs, as will be fully
detailed in <a href="10_4_Scripting_a_Multisig.md">§10.4: Scripting a
Multisig</a>.</li>
<li>OP_CHECKLOCKTIMEVERIFY and OP_SEQUENCEVERIFY form the basis of more
complex Timelocks, as will be fully detailed in <a
href="11_2_Using_CLTV_in_Scripts.md">§11.2: Using CLTV in Scripts</a>
and <a href="11_3_Using_CSV_in_Scripts.md">§11.3: Using CSV in
Scripts</a>.</li>
<li>OP_RETURN is the mark of an unspendable transaction, which is why
it’s used to carry data, as was alluded to in <a
href="08_2_Sending_a_Transaction_with_Data.md">§8.2: Sending a
Transaction with Data</a>.</li>
</ul>
<h2 id="access-scripts-in-your-transactions">Access Scripts In Your
Transactions</h2>
<p>You may not realize it, but you’ve already seen these locking and
unlocking scripts as part of the raw transactions you’ve been working
with. The best way to look into these scripts in more depth is thus to
create a raw transaction, then examine it.</p>
<h3 id="create-a-test-transaction">Create a Test Transaction</h3>
<p>To examine real unlocking and locking scripts, create a quick raw
transaction by grabbing an unspent Legacy UTXO sitting around, and
resending it to a Legacy change address, minus a transaction fee:</p>
<pre><code>$ utxo_txid=$(bitcoin-cli listunspent | jq -r &#39;.[1] | .txid&#39;) 
$ utxo_vout=$(bitcoin-cli listunspent | jq -r &#39;.[1] | .vout&#39;)
$ recipient=$(bitcoin-cli -named getrawchangeaddress address_type=legacy)
$ rawtxhex=$(bitcoin-cli -named createrawtransaction inputs=&#39;&#39;&#39;[ { &quot;txid&quot;: &quot;&#39;$utxo_txid&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout&#39; } ]&#39;&#39;&#39; outputs=&#39;&#39;&#39;{ &quot;&#39;$recipient&#39;&quot;: 0.0009 }&#39;&#39;&#39;)
$ signedtx=$(bitcoin-cli -named signrawtransactionwithwallet hexstring=$rawtxhex | jq -r &#39;.hex&#39;)</code></pre>
<p>You don’t actually need to send it: the goal is simply to produce a
complete transaction that you can examine.</p>
<blockquote>
<p><strong>NOTE:</strong> Why legacy addresses? Because their scripts
are more meaningful. However, we’ll also offer an example of a native
SegWit P2WPKH in <a href="09_5_Scripting_a_P2WPKH.md">§9.5</a>.</p>
</blockquote>
<h3 id="examine-your-test-transaction">Examine Your Test
Transaction</h3>
<p>You can now examine your transaction in depth by using
<code>decoderawtransaction</code> on the <code>$signedtx</code>:</p>
<pre><code>$ bitcoin-cli -named decoderawtransaction hexstring=$signedtx
{
  &quot;txid&quot;: &quot;34151dac704d94a269cd33f80be34c122152edc9bfbb9323852966bf0ce937ed&quot;,
  &quot;hash&quot;: &quot;34151dac704d94a269cd33f80be34c122152edc9bfbb9323852966bf0ce937ed&quot;,
  &quot;version&quot;: 2,
  &quot;size&quot;: 191,
  &quot;vsize&quot;: 191,
  &quot;weight&quot;: 764,
  &quot;locktime&quot;: 0,
  &quot;vin&quot;: [
    {
      &quot;txid&quot;: &quot;bb4362dec15e67d366088f5493c789f22fb4a604e767dae1f6a631687e2784aa&quot;,
      &quot;vout&quot;: 0,
      &quot;scriptSig&quot;: {
        &quot;asm&quot;: &quot;304402201cc39005b076cb06534cd084fcc522e7bf937c4c9654c1c9dfba68b92cbab7d1022066f273178febc7a37568e2e9f4dec980a2e9a95441abe838c7ef64c39d85849c[ALL] 0315a0aeb37634a71ede72d903acae4c6efa77f3423dcbcd6de3e13d9fd989438b&quot;,
        &quot;hex&quot;: &quot;47304402201cc39005b076cb06534cd084fcc522e7bf937c4c9654c1c9dfba68b92cbab7d1022066f273178febc7a37568e2e9f4dec980a2e9a95441abe838c7ef64c39d85849c01210315a0aeb37634a71ede72d903acae4c6efa77f3423dcbcd6de3e13d9fd989438b&quot;
      },
      &quot;sequence&quot;: 4294967295
    }
  ],
  &quot;vout&quot;: [
    {
      &quot;value&quot;: 0.00090000,
      &quot;n&quot;: 0,
      &quot;scriptPubKey&quot;: {
        &quot;asm&quot;: &quot;OP_DUP OP_HASH160 06b5c6ba5330cdf738a2ce91152bfd0e71f9ec39 OP_EQUALVERIFY OP_CHECKSIG&quot;,
        &quot;hex&quot;: &quot;76a91406b5c6ba5330cdf738a2ce91152bfd0e71f9ec3988ac&quot;,
        &quot;reqSigs&quot;: 1,
        &quot;type&quot;: &quot;pubkeyhash&quot;,
        &quot;addresses&quot;: [
          &quot;mg8S7F1gY3ivV9M9GrWwe6ziWvK2MFquCf&quot;
        ]
      }
    }
  ]
}
</code></pre>
<p>The two scripts are found in the two different parts of the
transaction.</p>
<p>The <code>scriptSig</code> is located in the <code>vin</code>. This
is the <em>unlocking</em> script. It’s what’s run to access the UTXO
being used to fund this transaction. There will be one
<code>scriptSig</code> per UTXO in a transaction.</p>
<p>The <code>scriptPubKey</code> is located in the <code>vout</code>.
This is the <em>locking</em> script. It’s what locks the new output from
the transaction. There will be one <code>scriptPubKey</code> per output
in a transaction.</p>
<blockquote>
<p>:book: <strong><em>How do the scriptSig and scriptPubKey
interact?</em></strong> The <code>scriptSig</code> of a transaction
unlocks the previous UTXO; this new transaction’s output will then be
locked with a <code>scriptPubKey</code>, which can in turn be unlocked
by the <code>scriptSig</code> of the transaction that reuses that
UTXO.</p>
</blockquote>
<h3 id="read-the-scripts-in-your-transaction">Read The Scripts in Your
Transaction</h3>
<p>Look at the two scripts and you’ll see that each includes two
different representations: the <code>hex</code> is what actually gets
stored, but the more readable assembly language (<code>asm</code>) can
sort of show you what’s going on.</p>
<p>Take a look at the <code>asm</code> of the unlocking script and
you’ll get your first look at what Bitcoin Scripting looks like:</p>
<pre><code>04402201cc39005b076cb06534cd084fcc522e7bf937c4c9654c1c9dfba68b92cbab7d1022066f273178febc7a37568e2e9f4dec980a2e9a95441abe838c7ef64c39d85849c[ALL] 0315a0aeb37634a71ede72d903acae4c6efa77f3423dcbcd6de3e13d9fd989438b</code></pre>
<p>As it happens, that mess of numbers is a private-key signature
followed by the associated public key. Or at least that’s hopefully what
it is, because that’s what’s required to unlock the P2PKH UTXO that this
transaction is using.</p>
<p>Read the locking script and you’ll see it’s a lot more obvious:</p>
<pre><code>OP_DUP OP_HASH160 06b5c6ba5330cdf738a2ce91152bfd0e71f9ec39 OP_EQUALVERIFY OP_CHECKSIG</code></pre>
<p>That is the standard method in Bitcoin Script for locking a P2PKH
transaction.</p>
<p><a href="09_4_Scripting_a_P2PKH.md">§9.4</a> will explain how these
two scripts go together, but first you will need to know how Bitcoin
Scripts are evaluated.</p>
<h2 id="examine-a-different-sort-of-transaction">Examine a Different
Sort of Transaction</h2>
<p>Before we leave this foundation behind, we’re going to look at a
different type of locking script. Here’s the <code>scriptPubKey</code>
from the multisig transaction that you created in <a
href="06_1_Sending_a_Transaction_to_a_Multisig.md">§6.1: Sending a
Transaction with a Multisig</a>.</p>
<pre><code>      &quot;scriptPubKey&quot;: {
        &quot;asm&quot;: &quot;OP_HASH160 a5d106eb8ee51b23cf60d8bd98bc285695f233f3 OP_EQUAL&quot;,
        &quot;hex&quot;: &quot;a914a5d106eb8ee51b23cf60d8bd98bc285695f233f387&quot;,
        &quot;reqSigs&quot;: 1,
        &quot;type&quot;: &quot;scripthash&quot;,
        &quot;addresses&quot;: [
          &quot;2N8MytPW2ih27LctLjn6LfLFZZb1PFSsqBr&quot;
        ]
      }</code></pre>
<p>Compare that to the <code>scriptPubKey</code> from your new P2PKH
transaction:</p>
<pre><code>    &quot;scriptPubKey&quot;: {
        &quot;asm&quot;: &quot;OP_DUP OP_HASH160 06b5c6ba5330cdf738a2ce91152bfd0e71f9ec39 OP_EQUALVERIFY OP_CHECKSIG&quot;,
        &quot;hex&quot;: &quot;76a91406b5c6ba5330cdf738a2ce91152bfd0e71f9ec3988ac&quot;,
        &quot;reqSigs&quot;: 1,
        &quot;type&quot;: &quot;pubkeyhash&quot;,
        &quot;addresses&quot;: [
          &quot;mg8S7F1gY3ivV9M9GrWwe6ziWvK2MFquCf&quot;
        ]
      }</code></pre>
<p>These two transactions are <em>definitely</em> locked in different
ways. Bitcoin recognises the first as <code>scripthash</code> (P2SH) and
the second as <code>pubkeyhash</code> (P2PKH), but you should also be
able to see the difference in the different <code>asm</code> code:
<code>OP_HASH160 a5d106eb8ee51b23cf60d8bd98bc285695f233f3 OP_EQUAL</code>
versus
<code>OP_DUP OP_HASH160 06b5c6ba5330cdf738a2ce91152bfd0e71f9ec39 OP_EQUALVERIFY OP_CHECKSIG</code>.
This is the power of scripting: it can very simply produce some of the
dramatically different sorts of transactions that you learned about in
the previous chapters.</p>
<h2 id="summary-understanding-the-foundation-of-transactions">Summary:
Understanding the Foundation of Transactions</h2>
<p>Every Bitcoin transaction includes at least one unlocking script
(<code>scriptSig</code>), which solves a previous cryptographic puzzle,
and at least one locking script (<code>scriptPubKey</code>), which
creates a new cryptographic puzzle. There’s one <code>scriptSig</code>
per input and one <code>scriptPubKey</code> per output. Each of these
scripts is written in Bitcoin Script, a Forth-like language that further
empowers Bitcoin.</p>
<blockquote>
<p>:fire: <strong><em>What is the power of scripts?</em></strong>
Scripts unlock the full power of Smart Contracts. With the appropriate
opcodes, you can make very precise decisions about who can redeem funds,
when they can redeem funds, and how they can redeem funds. More
intricate rules for corporate spending, partnership spending, proxy
spending, and other methodologies can also be encoded within a Script.
It even empowers more complex Bitcoin services such as Lightning and
sidechains.</p>
</blockquote>
<h2 id="whats-next">What’s Next?</h2>
<p>Continue “Introducing Bitcoin Scripts” with <a
href="09_2_Running_a_Bitcoin_Script.md">§9.2: Running a Bitcoin
Script</a>.</p>
</body>
</html>
