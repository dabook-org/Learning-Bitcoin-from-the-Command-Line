<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>08_1_Sending_a_Transaction_with_a_Locktime</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="sending-a-transaction-with-a-locktime">8.1: Sending a
Transaction with a Locktime</h1>
<p>The previous chapters showed two different ways to send funds from
multiple machines and to multiple recipients. But there are two other
ways to fundamentally change basic transactions. The first of these is
to vary time by choosing a locktime. This gives you the ability to send
raw transactions at some time in the future.</p>
<h2 id="understand-how-locktime-works">Understand How Locktime
Works</h2>
<p>When you create a locktime transaction, you lock it with a number
that represents either a block height (if it’s a small number) or a UNIX
timestamp (if it’s a big number). This tells the Bitcoin network that
the transaction may not be put into a block until either the specified
time has arrived or the blockchain has reached the specified height.</p>
<blockquote>
<p>:book: <em>What is block height?</em> It’s the total count of blocks
in the chain, going back to the genesis block for Bitcoin.</p>
</blockquote>
<p>When a locktime transaction is waiting to go into a block, it can be
cancelled. This means that it is far, far from finalized. In fact, the
ability to cancel is the whole purpose of a locktime transaction.</p>
<blockquote>
<p>:book: <em>What is nLockTime?</em> It’s the same thing as locktime.
More specifically, it’s what locktime is called internal to the Bitcoin
Core source code.</p>
</blockquote>
<blockquote>
<p>:book: <em>What is Timelock?</em> Locktime is just one way to lock
Bitcoin transactions until some point in the future; collectively these
methods are called timelocks. Locktime is the most basic timelock
method. It locks an entire transaction with an absolute time, and it’s
available through <code>bitcoin-cli</code> (which is why it’s the only
timelock covered in this section). A parallel method, which locks a
transaction with a relative time, is defined in <a
href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP
68</a> and covered in <a href="11_3_Using_CSV_in_Scripts.md">§11.3:
Using CSV in Scripts</a>.</p>
</blockquote>
<blockquote>
<p>Bitcoin Script further empowers both sorts of timelocks, allowing for
the locking of individual outputs instead of entire transactions.
Absolute timelocks (such as Locktime) are linked to the Script opcode
OP_CHECKLOCKTIMEVERIFY, which is defined in <a
href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">BIP
65</a> and covered in <a href="11_2_Using_CLTV_in_Scripts.md">§11.2:
Using CLTV in Scripts</a>, while relative timelocks (such as Timelock)
are linked to the Script opcode OP_CHECKSEQUENCEVERIFY, which is defined
in <a
href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP
112</a> and also covered in <a
href="11_3_Using_CSV_in_Scripts.md">§11.3</a>.</p>
</blockquote>
<h2 id="create-a-locktime-transaction">Create a Locktime
Transaction</h2>
<p>In order to create a locktime transaction, you need to first
determine what you will set the locktime to.</p>
<h3 id="figure-out-your-locktime-by-unix-timestamp">Figure Out Your
Locktime By UNIX Timestamp</h3>
<p>Most frequently you will set the locktime to a UNIX timestamp
representing a specific date and time. You can calculate a UNIX
timestamp at a web site like <a
href="http://www.unixtimestamp.com/">UNIX Time Stamp</a> or <a
href="https://www.epochconverter.com/">Epoch Convertor</a>. However, it
would be better to <a href="https://www.epochconverter.com/#code">write
your own script</a> on your local machine, so that you know the UNIX
timestamp you receive is accurate. If you don’t do that, at least double
check on two different sites.</p>
<blockquote>
<p>:book: <em>Why Would I Use a UNIX Timestamp?</em> Using a UNIX
timestamp makes it easy to definitively link a transaction to a specific
time, without worrying about whether the speed of block creation might
change at some point. Particularly if you’re creating a locktime that’s
far in the future, it’s the safer thing to do. But, beyond that, it’s
just more intuitive, creating a direct correlation between some calendar
date and the time when the transaction can be mined.</p>
</blockquote>
<blockquote>
<p>:warning: <strong>WARNING:</strong> Locktime with UNIX timestamps has
a bit of wriggle room: the release of blocks isn’t regular and block
times can be two hours ahead of real time, so a locktime actually means
“within a few hours of this time, plus or minus”.</p>
</blockquote>
<h3 id="figure-out-your-locktime-by-block-height">Figure Out Your
Locktime By Block Height</h3>
<p>Alternatively, you can set the locktime to a smaller number
representing a block height. To calculate your future block height, you
need to first know what the current block height is.
<code>bitcoin-cli getblockcount</code> will tell you what your local
machine thinks the block height is. You may want to double-check with a
Bitcoin explorer.</p>
<p>Once you’ve figured out the current height, you can decide how far in
the future to set your locktime to. Remember that on average a new block
will be created every 10 minutes. So, for example, if you wanted to set
the locktime to a week in the future, you’d choose a block height that
is 6 x 24 x 7 = 1,008 blocks in advance of the current one.</p>
<blockquote>
<p>:book: <em>Why Would I Use a Blockheight?</em> Unlike with
timestamps, there’s no fuzziness for blockheights. If you set a
blockheight of 120,000 for your locktime, then there’s absolutely no way
for it to go into block 119,999. This can make it easier to
algorithmically control your locktimed transaction. The downside is that
you can’t be as sure of when precisely the locktime will be.</p>
</blockquote>
<blockquote>
<p>:warning: <strong>WARNING:</strong> If you want to set a block-height
locktime, you must set the locktime to less than 500 million. If you set
it to 500 million or over, your number will instead be interpreted as a
timestamp. Since the UNIX timestamp of 500 million was November 5, 1985,
that probably means that your transaction will be put into a block at
the miners’ first opportunity.</p>
</blockquote>
<h2 id="write-your-transaction">Write Your Transaction</h2>
<p>Once you have figured out your locktime, all you need to do is write
up a typical raw transaction, with a third variable for
<code>locktime</code>:</p>
<pre><code>$ rawtxhex=$(bitcoin-cli -named createrawtransaction inputs=&#39;&#39;&#39;[ { &quot;txid&quot;: &quot;&#39;$utxo_txid&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout&#39; } ]&#39;&#39;&#39; outputs=&#39;&#39;&#39;{ &quot;&#39;$recipient&#39;&quot;: 0.001, &quot;&#39;$changeaddress&#39;&quot;: 0.00095 }&#39;&#39;&#39; locktime=1774650)</code></pre>
<p>Note that this usage of <code>locktime</code> is under 500 million,
which means that it defines a block height. In this case, it’s just a
few blocks past the current block height at the time of this writing,
meant to exemplify how locktime works without sitting around for a long
time to wait and see what happens.</p>
<p>Here’s what the created transaction looks like:</p>
<pre><code>$ bitcoin-cli -named decoderawtransaction hexstring=$rawtxhex 
{
  &quot;txid&quot;: &quot;ba440b1dd87a7ccb6a200f087d2265992588284eed0ae455d0672aeb918cf71e&quot;,
  &quot;hash&quot;: &quot;ba440b1dd87a7ccb6a200f087d2265992588284eed0ae455d0672aeb918cf71e&quot;,
  &quot;version&quot;: 2,
  &quot;size&quot;: 113,
  &quot;vsize&quot;: 113,
  &quot;weight&quot;: 452,
  &quot;locktime&quot;: 1774650,
  &quot;vin&quot;: [
    {
      &quot;txid&quot;: &quot;0ad9fb6992dfe4ea90236b69852b3605c0175633b32996a486dcd0b2e739e385&quot;,
      &quot;vout&quot;: 1,
      &quot;scriptSig&quot;: {
        &quot;asm&quot;: &quot;&quot;,
        &quot;hex&quot;: &quot;&quot;
      },
      &quot;sequence&quot;: 4294967294
    }
  ],
  &quot;vout&quot;: [
    {
      &quot;value&quot;: 0.00100000,
      &quot;n&quot;: 0,
      &quot;scriptPubKey&quot;: {
        &quot;asm&quot;: &quot;0 f333554cc0830d03a9c1f26758e2e7e0f155539f&quot;,
        &quot;hex&quot;: &quot;0014f333554cc0830d03a9c1f26758e2e7e0f155539f&quot;,
        &quot;reqSigs&quot;: 1,
        &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
        &quot;addresses&quot;: [
          &quot;tb1q7ve42nxqsvxs82wp7fn43ch8urc425ul5um4un&quot;
        ]
      }
    },
    {
      &quot;value&quot;: 0.00095000,
      &quot;n&quot;: 1,
      &quot;scriptPubKey&quot;: {
        &quot;asm&quot;: &quot;0 a37718a3510958112b6a766e0023ff251b6c2bfb&quot;,
        &quot;hex&quot;: &quot;0014a37718a3510958112b6a766e0023ff251b6c2bfb&quot;,
        &quot;reqSigs&quot;: 1,
        &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
        &quot;addresses&quot;: [
          &quot;tb1q5dm33g63p9vpz2m2wehqqglly5dkc2lmtmr98d&quot;
        ]
      }
    }
  ]
}</code></pre>
<p>Note that the sequence number (<code>4294967294</code>) is less than
<code>0xffffffff</code>. This is necessary signalling to show that the
transaction includes a locktime. It’s also done automatically by
<code>bitcoin-cli</code>. If the sequence number is instead set to
<code>0xffffffff</code>, your locktime will be ignored.</p>
<blockquote>
<p>:information_source: <strong>NOTE — SEQUENCE:</strong> This is the
second use of the <code>nSequence</code> value in Bitcoin. As with RBF,
<code>nSequence</code> is again used as an opt-in, this time for the use
of locktime. 0xffffffff-1 (4294967294) is the preferred value for
signalling locktime because it purposefully disallows the use of both
RBF (which requires <code>nSequence &lt; 0xffffffff-1</code>) and
relative timelock (which requires
<code>nSequence &lt; 0xf0000000</code>), the other two uses of the
<code>nSequence</code> value. If you set <code>nSequence</code> lower
than <code>0xf0000000</code>, then you will also relative timelock your
transaction, which is probably not what you want.</p>
</blockquote>
<blockquote>
<p>:warning: <strong>WARNING:</strong> If you are creating a locktime
raw transaction by some other means than <code>bitcoin-cli</code>, you
will have to set the sequence to less than <code>0xffffffff</code> by
hand.</p>
</blockquote>
<h2 id="send-your-transaction">Send Your Transaction</h2>
<p>By now you’re probably well familiar with finishing things up:</p>
<pre><code>$ signedtx=$(bitcoin-cli -named signrawtransactionwithwallet hexstring=$rawtxhex | jq -r &#39;.hex&#39;)
$ bitcoin-cli -named sendrawtransaction hexstring=$signedtx
error code: -26
error message:
non-final</code></pre>
<p>Whoop! What’s that error!?</p>
<p>Since 2013, you generally can’t place the timelocked transaction into
the mempool until its lock has expired. However, you can still hold the
transaction, occasionally resending it to the Bitcoin network until it’s
accepted into the mempool. Alternatively, you could send the signed
transaction (<code>$signedtx</code>) to the recipient, so that he could
place it in the mempool when the locktime has expired.</p>
<p>Once the locktime is past, anyone can send that signed transaction to
the network, and the recipient will receive the money as intended …
provided that the transaction hasn’t been cancelled.</p>
<h2 id="cancel-a-locktime-transaction">Cancel a Locktime
Transaction</h2>
<p>Cancelling a locktime transaction is <em>very</em> simple: you send a
new transactions using at least one of the same UTXOs.</p>
<h2 id="summary-sending-a-transaction-with-a-locktime">Summary: Sending
a Transaction with a Locktime</h2>
<p>Locktime offers a way to create a transaction that <em>should</em>
not be relayable to the network and that <em>will</em> not be accepted
into a block until the appropriate time has arrived. In the meantime, it
can be cancelled simply by reusing a UTXO.</p>
<blockquote>
<p>:fire: <em>What is the Power of Locktime?</em> The power of locktime
may not be immediately obvious because of the ability to cancel it so
easily. However, it’s another of the bases of Smart Contracts: it has a
lot of utility in a variety of custodial or contractual applications.
For example, consider a situation where a third party is holding your
bitcoins. In order to guarantee the return of your bitcoins if the
custodian ever disappeared, they could produce a timelock transaction to
return the coins to you, then update that every once in a while with a
new one, further in the future. If they ever failed to update, then the
coins would return to you when the current timelock expired. Locktime
could similarly be applied to a payment network, where the network holds
coins while they’re being exchanged by network participants. Finally, a
will offers an example of a more complex contract, where payments are
sent out to a number of people. These payments would be built on
locktime transactions, and would be continually updated as long as the
owner continues to show signs of life. (The unifying factor of all of
these applications is, of course, <em>trust</em>. Simple locktime
transactions only work if the holder of the coins can be trusted to send
them out under the appropriate conditions.)</p>
</blockquote>
<h2 id="whats-next">What’s Next?</h2>
<p>Continue “Expanding Bitcoin Transactions” with <a
href="08_2_Sending_a_Transaction_with_Data.md">§8.2: Sending a
Transaction with Data</a>.</p>
</body>
</html>
