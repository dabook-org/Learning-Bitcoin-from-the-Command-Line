<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>07_1_Creating_a_Partially_Signed_Bitcoin_Transaction</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="creating-a-partially-signed-bitcoin-transaction">7.1: Creating a
Partially Signed Bitcoin Transaction</h1>
<blockquote>
<p>:information_source: <strong>NOTE:</strong> This section has been
recently added to the course and is an early draft that may still be
awaiting review. Caveat reader.</p>
</blockquote>
<p>Partially Signed Bitcoin Transactions (PSBTs) are the newest way to
vary the creation of basic Bitcoin transactions. They do so by
introducing collaboration into every step of the process, allowing
people (or programs) to not just authenticate transactions together (as
with multisigs), but also to easily create, fund, and broadcast
collaboratively.</p>
<blockquote>
<p>:warning: <strong>VERSION WARNING:</strong> This is an innovation
from Bitcoin Core v 0.17.0. Earlier versions of Bitcoin Core will not be
able to work with the PSBT while it is in progress (though they will
still be able to recognize the final transaction). Some updates and
upgrades for PSBTs have continued through 0.20.0.</p>
</blockquote>
<h2 id="understand-how-psbts-work">Understand How PSBTs Work</h2>
<p>Multisignatures were great for the very specific case of jointly
holding funds and setting rules for whom among the joint signers could
authenticate the use of those funds. There are many use cases, such as:
a spousal joint bank account (a 1-of-2 signature); a fiduciary
requirement for dual control (a 2-of-2 signature); and an escrow (a
2-of-3 signature).</p>
<blockquote>
<p>:book: <strong><em>What is a PSBT?</em></strong> As the name
suggests, a PSBT is a transaction that has not been fully signed. That’s
important, because once a transaction is signed, its content is locked
in. <a
href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP174</a>
defined an abstracted methodology for putting PSBTs together that
describes and standardizes roles in their collaborative creation. A
<em>Creator</em> proposes a transaction; one or more <em>Updaters</em>
supplement it; and one or more <em>Signers</em> authenticate it; before
a <em>Finalizer</em> completes it; and an <em>Extracter</em> turns it
into a transaction for the Bitcoin network. There may also be a
<em>Combiner</em> who merges parallel PSBTs from different users.</p>
</blockquote>
<p>PSBTs may initially look sort of the same as multi-sigs because they
have a single overlapping bit of functionality: the ability to jointly
sign a transaction. However, they were created for a totally different
use case. PSBTs recognize the need for multiple programs to jointly
create a transaction for a number of different reasons, and they provide
a regularized format for doing so. They’re especially useful for use
cases involving hardware wallets (for which, see <a
href="https://github.com/BlockchainCommons/Learning-Bitcoin-from-the-Command-Line/blob/master/07_3_Integrating_with_Hardware_Wallets.md">§7.3</a>),
which are protected from full access to the internet and tend to have
minimal transaction history.</p>
<p>In general, PSBTs provide a number of functional elements that
improve this use case:</p>
<ol type="1">
<li>They provide a <em>standard</em> for collaboratively creating
transactions, whereas previous methodologies (including the multi-sig
one from the previous chapter) were implementation dependent.</li>
<li>They support a <em>wider variety of use cases</em>, including simple
joint funding.</li>
<li>They support <em>hardware wallets</em> and other cases where a node
may not have full transaction history.</li>
<li>They optionally allow for the combination of <em>non-serialized
transactions</em>, not requiring an ever-bigger hex code to be passed
from user to user.</li>
</ol>
<p>PSBTs do their work by supplementing normal transaction information
with a set of inputs and outputs, each of which defines everything you
need to know about those UTXOs, so that even an airgapped wallet can
make an informed decision about signatures. Thus, an input lists out the
amount of money in a UTXO and what needs to be done to spend it, while
an output does the same for the UTXOs it’s creating.</p>
<p>This first section will outline the standard PSBT process of:
Creator, Updater, Signer, Finalizer, Extractor. It’ll do so from one
machine, which will sort of make this look like a convoluted way to
create a raw transaction. But, have faith, there’s a purpose to this! <a
href="07_2_Using_a_Partially_Signed_Bitcoin_Transaction.md">§7.2</a> and
<a href="/07_3_Integrating_with_Hardware_Wallets.md">§7.3</a> will show
some real-life examples of using PSBTs and will turn this simple system
into a collaborative process shared between multiple machines that has
real effects and creates real opportunities.</p>
<h2 id="create-a-psbt-the-old-fashioned-way">Create a PSBT the
Old-Fashioned Way</h2>
<h4 id="psbt-role-creator">PSBT Role: Creator</h4>
<p>The easiest way to create a PSBT is to take an existing transaction
and use <code>converttopsbt</code> to turn it into a PSBT. This is
certainly not the <em>best</em> way since it requires you to make a
transaction for one format (a raw transaction) then convert it to
another (PSBT), but if you’ve got old software that can only generate a
raw transaction, you may need to use it.</p>
<p>You just create your raw transaction normally:</p>
<pre><code>$ utxo_txid_1=$(bitcoin-cli listunspent | jq -r &#39;.[0] | .txid&#39;)
$ utxo_vout_1=$(bitcoin-cli listunspent | jq -r &#39;.[0] | .vout&#39;)
$ utxo_txid_2=$(bitcoin-cli listunspent | jq -r &#39;.[1] | .txid&#39;)
$ utxo_vout_2=$(bitcoin-cli listunspent | jq -r &#39;.[1] | .vout&#39;)
$ echo $utxo_txid_1 $utxo_vout_1 $utxo_txid_2 $utxo_vout_2
c6de60427b28d8ec8102e49771e5d0348fc3ef6a5bf02eb864ec745105a6951b 1 8748eff5f12ca886e3603d9e30227dcb3f0332e0706c4322fec96001f7c7f41c 0
$ recipient=tb1qcaedd724gts3aug73m78c7nfsv9d8zs9q6h2kd
$ rawtxhex=$(bitcoin-cli -named createrawtransaction inputs=&#39;&#39;&#39;[ { &quot;txid&quot;: &quot;&#39;$utxo_txid_1&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout_1&#39; }, { &quot;txid&quot;: &quot;&#39;$utxo_txid_2&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout_2&#39; } ]&#39;&#39;&#39; outputs=&#39;&#39;&#39;{ &quot;&#39;$recipient&#39;&quot;: 0.0000065 }&#39;&#39;&#39;)</code></pre>
<p>Then you convert it:</p>
<pre><code>$ psbt=$(bitcoin-cli -named converttopsbt hexstring=$rawtxhex)
$ echo $psbt
cHNidP8BAHsCAAAAAhuVpgVRdOxkuC7wW2rvw4800OVxl+QCgezYKHtCYN7GAQAAAAD/////HPTH9wFgyf4iQ2xw4DIDP8t9IjCePWDjhqgs8fXvSIcAAAAAAP////8BigIAAAAAAAAWABTHctb5VULhHvEejvx8emmDCtOKBQAAAAAAAAAA</code></pre>
<p>You’ll note that the PSBT encoding looks very different from the
transaction hex.</p>
<p>But if you can, you want to create the PSBT directly instead …</p>
<h2 id="create-a-psbt-the-hard-way">Create a PSBT the Hard Way</h2>
<h4 id="psbt-role-creator-1">PSBT Role: Creator</h4>
<p>The first methodology for creating a PSBT without going through
another format is the PSBT-equivalent of
<code>createrawtransaction</code>. It’s called <code>createpsbt</code>
and it gives you maximal control at the cost of maximal labor and the
maximal opportunity for error.</p>
<p>The CLI should look quite familiar, just with a new RPC command:</p>
<pre><code>$ psbt_1=$(bitcoin-cli -named createpsbt inputs=&#39;&#39;&#39;[ { &quot;txid&quot;: &quot;&#39;$utxo_txid_1&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout_1&#39; }, { &quot;txid&quot;: &quot;&#39;$utxo_txid_2&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout_2&#39; } ]&#39;&#39;&#39; outputs=&#39;&#39;&#39;{ &quot;&#39;$recipient&#39;&quot;: 0.0000065 }&#39;&#39;&#39;)</code></pre>
<p>The Bitcoin Core team made sure that <code>createpsbt</code> worked
much like <code>createrawtransaction</code>, so you don’t need to learn
a different creation format.</p>
<p>You can verify that the new PSBT is the same as the one created by
<code>converttopsbt</code>:</p>
<pre><code>$ echo $psbt_1
cHNidP8BAHsCAAAAAhuVpgVRdOxkuC7wW2rvw4800OVxl+QCgezYKHtCYN7GAQAAAAD/////HPTH9wFgyf4iQ2xw4DIDP8t9IjCePWDjhqgs8fXvSIcAAAAAAP////8BigIAAAAAAAAWABTHctb5VULhHvEejvx8emmDCtOKBQAAAAAAAAAA
$ if [ &quot;$psbt&quot; == &quot;$psbt_1&quot; ]; then     echo &quot;PSBTs are equal&quot;; else     echo &quot;PSBTs are not equal&quot;; fi
PSBTs are equal</code></pre>
<h2 id="examine-a-psbt">Examine a PSBT</h2>
<h4 id="psbt-role-any">PSBT Role: Any</h4>
<p>So what does your PSBT actually look like? You can see that with the
<code>decodepsbt</code> command:</p>
<pre><code>$ bitcoin-cli -named decodepsbt psbt=$psbt
{
  &quot;tx&quot;: {
    &quot;txid&quot;: &quot;ea73a631b456d2b041ed73bf5767946408c6ff067716929a68ecda2e3e4de6d3&quot;,
    &quot;hash&quot;: &quot;ea73a631b456d2b041ed73bf5767946408c6ff067716929a68ecda2e3e4de6d3&quot;,
    &quot;version&quot;: 2,
    &quot;size&quot;: 123,
    &quot;vsize&quot;: 123,
    &quot;weight&quot;: 492,
    &quot;locktime&quot;: 0,
    &quot;vin&quot;: [
      {
        &quot;txid&quot;: &quot;c6de60427b28d8ec8102e49771e5d0348fc3ef6a5bf02eb864ec745105a6951b&quot;,
        &quot;vout&quot;: 1,
        &quot;scriptSig&quot;: {
          &quot;asm&quot;: &quot;&quot;,
          &quot;hex&quot;: &quot;&quot;
        },
        &quot;sequence&quot;: 4294967295
      },
      {
        &quot;txid&quot;: &quot;8748eff5f12ca886e3603d9e30227dcb3f0332e0706c4322fec96001f7c7f41c&quot;,
        &quot;vout&quot;: 0,
        &quot;scriptSig&quot;: {
          &quot;asm&quot;: &quot;&quot;,
          &quot;hex&quot;: &quot;&quot;
        },
        &quot;sequence&quot;: 4294967295
      }
    ],
    &quot;vout&quot;: [
      {
        &quot;value&quot;: 0.00000650,
        &quot;n&quot;: 0,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 c772d6f95542e11ef11e8efc7c7a69830ad38a05&quot;,
          &quot;hex&quot;: &quot;0014c772d6f95542e11ef11e8efc7c7a69830ad38a05&quot;,
          &quot;reqSigs&quot;: 1,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;addresses&quot;: [
            &quot;tb1qcaedd724gts3aug73m78c7nfsv9d8zs9q6h2kd&quot;
          ]
        }
      }
    ]
  },
  &quot;unknown&quot;: {
  },
  &quot;inputs&quot;: [
    {
    },
    {
    }
  ],
  &quot;outputs&quot;: [
    {
    }
  ]
}</code></pre>
<p>It’s important to note that even though we’ve defined the
fundamentals of the transaction: the <code>vins</code> of where the
money is coming from and the <code>vouts</code> of where it’s going to,
we haven’t yet defined the <code>inputs</code> and <code>outputs</code>
that are the heart of a PSBT and that are required for offline users to
assess them. This is expected: the role of the Creator as defined in <a
href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP174</a>
is to outline the transaction, while the role of the Updater is to start
filling in the PSBT-specific data. (Other commands combine the Creator
and Updater roles, but <code>createpsbt</code> doesn’t because it
doesn’t have access to your wallet.)</p>
<p>You can also use the <code>analyzepsbt</code> command to look at its
current state:</p>
<pre><code>standup@btctest20:~$ bitcoin-cli -named analyzepsbt psbt=$psbt
{
  &quot;inputs&quot;: [
    {
      &quot;has_utxo&quot;: false,
      &quot;is_final&quot;: false,
      &quot;next&quot;: &quot;updater&quot;
    },
    {
      &quot;has_utxo&quot;: false,
      &quot;is_final&quot;: false,
      &quot;next&quot;: &quot;updater&quot;
    }
  ],
  &quot;next&quot;: &quot;updater&quot;
}</code></pre>
<p>Similarly, <code>analyzepsbt</code> shows us a PSBT that needs work.
We get a look at each of the two <code>inputs</code> (corresponding to
the two <code>vins</code>), and neither one has the information it
needs.</p>
<h2 id="finalize-a-psbt">Finalize a PSBT</h2>
<h4 id="psbt-role-updater-signer-finalizer">PSBT Role: Updater, Signer,
Finalizer</h4>
<p>There is a <code>utxoupdatepsbt</code> command that can be used to
Update UTXOs, importing their descriptor information by hand, but you
don’t want to use it unless you have a use case where you don’t have all
of that information in the wallets of everyone who will be signing the
PSBT.</p>
<blockquote>
<p>:information_source: <strong>NOTE:</strong> If you choose to Update
the PSBT with <code>utxoupdatepsbt</code>, you would still need to use
<code>walletprocesspsbt</code> to Sign it: it’s the only Signer-role
command for PSBTs that’s available in <code>bitcoin-cli</code>.</p>
</blockquote>
<p>Instead, you should use <code>walletprocesspsbt</code>, which will
Update, Sign, and Finalize:</p>
<pre><code>$ bitcoin-cli walletprocesspsbt $psbt
{
  &quot;psbt&quot;: &quot;cHNidP8BAHsCAAAAAhuVpgVRdOxkuC7wW2rvw4800OVxl+QCgezYKHtCYN7GAQAAAAD/////HPTH9wFgyf4iQ2xw4DIDP8t9IjCePWDjhqgs8fXvSIcAAAAAAP////8BigIAAAAAAAAWABTHctb5VULhHvEejvx8emmDCtOKBQAAAAAAAQEfAQAAAAAAAAAWABRsRdOvqHYghsS9dtinGsfJduGRlgEIawJHMEQCIAqJbxz6dBzNpfaDu4XZXb+DbDkM3UWnhezh9UdmeVghAiBRxMlW2o0wEtphtUZRWIiJOaGtXfsQbB4lovkvE4eRIgEhArrDpkX9egpTfGJ6039faVBYxY0ZzrADPpE/Gpl14A3uAAEBH0gDAAAAAAAAFgAU1ZEJG4B0ojde2ZhanEsY7+z9QWUBCGsCRzBEAiB+sNNCO4xiFQ+DoHVrqqk9yM0V4H9ZSyExx1PW7RbjsgIgUeWkQ3L7aAv1xIe7h+8PZb8ECsXg1UzbtPW8wd2qx0UBIQKIO7VGPjfVUlLYs9XCFBsAezfIp9tiEfdclVrMXqMl6wAA&quot;,
  &quot;complete&quot;: true
}</code></pre>
<p>Obviously, you’re going to need to save that <code>psbt</code>
information using <code>jq</code>:</p>
<pre><code>$ psbt_f=$(bitcoin-cli walletprocesspsbt $psbt | jq -r &#39;.psbt&#39;)</code></pre>
<p>You can see the <code>inputs</code> have now been filled in:</p>
<pre><code>$ bitcoin-cli decodepsbt $psbt_f
{
  &quot;tx&quot;: {
    &quot;txid&quot;: &quot;ea73a631b456d2b041ed73bf5767946408c6ff067716929a68ecda2e3e4de6d3&quot;,
    &quot;hash&quot;: &quot;ea73a631b456d2b041ed73bf5767946408c6ff067716929a68ecda2e3e4de6d3&quot;,
    &quot;version&quot;: 2,
    &quot;size&quot;: 123,
    &quot;vsize&quot;: 123,
    &quot;weight&quot;: 492,
    &quot;locktime&quot;: 0,
    &quot;vin&quot;: [
      {
        &quot;txid&quot;: &quot;c6de60427b28d8ec8102e49771e5d0348fc3ef6a5bf02eb864ec745105a6951b&quot;,
        &quot;vout&quot;: 1,
        &quot;scriptSig&quot;: {
          &quot;asm&quot;: &quot;&quot;,
          &quot;hex&quot;: &quot;&quot;
        },
        &quot;sequence&quot;: 4294967295
      },
      {
        &quot;txid&quot;: &quot;8748eff5f12ca886e3603d9e30227dcb3f0332e0706c4322fec96001f7c7f41c&quot;,
        &quot;vout&quot;: 0,
        &quot;scriptSig&quot;: {
          &quot;asm&quot;: &quot;&quot;,
          &quot;hex&quot;: &quot;&quot;
        },
        &quot;sequence&quot;: 4294967295
      }
    ],
    &quot;vout&quot;: [
      {
        &quot;value&quot;: 0.00000650,
        &quot;n&quot;: 0,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 c772d6f95542e11ef11e8efc7c7a69830ad38a05&quot;,
          &quot;hex&quot;: &quot;0014c772d6f95542e11ef11e8efc7c7a69830ad38a05&quot;,
          &quot;reqSigs&quot;: 1,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;addresses&quot;: [
            &quot;tb1qcaedd724gts3aug73m78c7nfsv9d8zs9q6h2kd&quot;
          ]
        }
      }
    ]
  },
  &quot;unknown&quot;: {
  },
  &quot;inputs&quot;: [
    {
      &quot;witness_utxo&quot;: {
        &quot;amount&quot;: 0.00000001,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 6c45d3afa8762086c4bd76d8a71ac7c976e19196&quot;,
          &quot;hex&quot;: &quot;00146c45d3afa8762086c4bd76d8a71ac7c976e19196&quot;,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;address&quot;: &quot;tb1qd3za8tagwcsgd39awmv2wxk8e9mwryvktqmkkg&quot;
        }
      },
      &quot;final_scriptwitness&quot;: [
        &quot;304402200a896f1cfa741ccda5f683bb85d95dbf836c390cdd45a785ece1f54766795821022051c4c956da8d3012da61b5465158888939a1ad5dfb106c1e25a2f92f1387912201&quot;,
        &quot;02bac3a645fd7a0a537c627ad37f5f695058c58d19ceb0033e913f1a9975e00dee&quot;
      ]
    },
    {
      &quot;witness_utxo&quot;: {
        &quot;amount&quot;: 0.00000840,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 d591091b8074a2375ed9985a9c4b18efecfd4165&quot;,
          &quot;hex&quot;: &quot;0014d591091b8074a2375ed9985a9c4b18efecfd4165&quot;,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;address&quot;: &quot;tb1q6kgsjxuqwj3rwhkenpdfcjccalk06st9z0k0kh&quot;
        }
      },
      &quot;final_scriptwitness&quot;: [
        &quot;304402207eb0d3423b8c62150f83a0756baaa93dc8cd15e07f594b2131c753d6ed16e3b2022051e5a44372fb680bf5c487bb87ef0f65bf040ac5e0d54cdbb4f5bcc1ddaac74501&quot;,
        &quot;02883bb5463e37d55252d8b3d5c2141b007b37c8a7db6211f75c955acc5ea325eb&quot;
      ]
    }
  ],
  &quot;outputs&quot;: [
    {
    }
  ],
  &quot;fee&quot;: 0.00000191
}</code></pre>
<p>Or to be more precise: (1) the PSBT has been updated with the
<code>witness_utxo</code> information; (2) the PSBT has been signed; and
(3) the PSBT has been finalized.</p>
<h2 id="create-a-psbt-the-easy-way">Create a PSBT the Easy Way</h2>
<h4 id="psbt-role-creator-updater">PSBT Role: Creator, Updater</h4>
<p>If you think that there should be a command that’s the equivalent of
<code>fundrawtransaction</code>, you’ll be pleased to know there is:
<code>walletcreatefundedpsbt</code>. You could use it just the same as
<code>createpsbt</code>:</p>
<pre><code>$ bitcoin-cli -named walletcreatefundedpsbt inputs=&#39;&#39;&#39;[ { &quot;txid&quot;: &quot;&#39;$utxo_txid_1&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout_1&#39; }, { &quot;txid&quot;: &quot;&#39;$utxo_txid_2&#39;&quot;, &quot;vout&quot;: &#39;$utxo_vout_2&#39; } ]&#39;&#39;&#39; outputs=&#39;&#39;&#39;{ &quot;&#39;$recipient&#39;&quot;: 0.0000065 }&#39;&#39;&#39;
{
  &quot;psbt&quot;: &quot;cHNidP8BAOwCAAAABBuVpgVRdOxkuC7wW2rvw4800OVxl+QCgezYKHtCYN7GAQAAAAD/////HPTH9wFgyf4iQ2xw4DIDP8t9IjCePWDjhqgs8fXvSIcAAAAAAP/////uFwerANKjyVK6WaR7gzlX+lOf+ORsfjP5LYCSNIbhaAAAAAAA/v///4XjOeey0NyGpJYpszNWF8AFNiuFaWsjkOrk35Jp+9kKAAAAAAD+////AtYjEAAAAAAAFgAUMPsier2ey1eH48oGqrbbYGzNHgKKAgAAAAAAABYAFMdy1vlVQuEe8R6O/Hx6aYMK04oFAAAAAAABAR8BAAAAAAAAABYAFGxF06+odiCGxL122Kcax8l24ZGWIgYCusOmRf16ClN8YnrTf19pUFjFjRnOsAM+kT8amXXgDe4Q1gQ4AAAAAIABAACADgAAgAABAR9IAwAAAAAAABYAFNWRCRuAdKI3XtmYWpxLGO/s/UFlIgYCiDu1Rj431VJS2LPVwhQbAHs3yKfbYhH3XJVazF6jJesQ1gQ4AAAAAIABAACADAAAgAABAIwCAAAAAdVmsvkSBmfeHqNAe/wDCQ5lEp9F/587ftzCD1UL60nMAQAAABcWABRzFxRJfFPl8FJ6SxjAJzy3mCAMXf7///8CQEIPAAAAAAAZdqkUf0NzebzGbEB0XtwYkeprODDhl12IrMEwLQAAAAAAF6kU/d+kMX6XijmD+jWdUrLZlJUnH2iHPhQbACIGA+/e40wACf0XXzsgteWlUX/V0WdG8uY1tEYXra/q68OIENYEOAAAAACAAAAAgBIAAIAAAQEfE4YBAAAAAAAWABTVkQkbgHSiN17ZmFqcSxjv7P1BZSIGAog7tUY+N9VSUtiz1cIUGwB7N8in22IR91yVWsxeoyXrENYEOAAAAACAAQAAgAwAAIAAIgICKMavAB+71Adqsbf+XtC1g/OlmLEuTp3U0axyeu/LAI0Q1gQ4AAAAAIABAACAGgAAgAAA&quot;,
  &quot;fee&quot;: 0.00042300,
  &quot;changepos&quot;: 0
}</code></pre>
<p>However, the big advantage is that you can use it to self-fund by
leaving out the <code>inputs</code>, just like
<code>fundrawtransaction</code>.</p>
<pre><code>$ psbt_new=$(bitcoin-cli -named walletcreatefundedpsbt inputs=&#39;&#39;&#39;[]&#39;&#39;&#39; outputs=&#39;&#39;&#39;{ &quot;&#39;$recipient&#39;&quot;: 0.0000065 }&#39;&#39;&#39; | jq -r &#39;.psbt&#39;)
$ bitcoin-cli decodepsbt $psbt_new
{
  &quot;tx&quot;: {
    &quot;txid&quot;: &quot;9f2c6205ac797c1020f7f261e3ab71cd0699ff4b1a8934f68b273c71547e235f&quot;,
    &quot;hash&quot;: &quot;9f2c6205ac797c1020f7f261e3ab71cd0699ff4b1a8934f68b273c71547e235f&quot;,
    &quot;version&quot;: 2,
    &quot;size&quot;: 154,
    &quot;vsize&quot;: 154,
    &quot;weight&quot;: 616,
    &quot;locktime&quot;: 0,
    &quot;vin&quot;: [
      {
        &quot;txid&quot;: &quot;8748eff5f12ca886e3603d9e30227dcb3f0332e0706c4322fec96001f7c7f41c&quot;,
        &quot;vout&quot;: 0,
        &quot;scriptSig&quot;: {
          &quot;asm&quot;: &quot;&quot;,
          &quot;hex&quot;: &quot;&quot;
        },
        &quot;sequence&quot;: 4294967294
      },
      {
        &quot;txid&quot;: &quot;68e1863492802df9337e6ce4f89f53fa5739837ba459ba52c9a3d200ab0717ee&quot;,
        &quot;vout&quot;: 0,
        &quot;scriptSig&quot;: {
          &quot;asm&quot;: &quot;&quot;,
          &quot;hex&quot;: &quot;&quot;
        },
        &quot;sequence&quot;: 4294967294
      }
    ],
    &quot;vout&quot;: [
      {
        &quot;value&quot;: 0.00971390,
        &quot;n&quot;: 0,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 09a74ef0bae4d68b0b2ec9a7c4557a2b5c85bd8b&quot;,
          &quot;hex&quot;: &quot;001409a74ef0bae4d68b0b2ec9a7c4557a2b5c85bd8b&quot;,
          &quot;reqSigs&quot;: 1,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;addresses&quot;: [
            &quot;tb1qpxn5au96untgkzewexnug4t69dwgt0vtfahcv6&quot;
          ]
        }
      },
      {
        &quot;value&quot;: 0.00000650,
        &quot;n&quot;: 1,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 c772d6f95542e11ef11e8efc7c7a69830ad38a05&quot;,
          &quot;hex&quot;: &quot;0014c772d6f95542e11ef11e8efc7c7a69830ad38a05&quot;,
          &quot;reqSigs&quot;: 1,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;addresses&quot;: [
            &quot;tb1qcaedd724gts3aug73m78c7nfsv9d8zs9q6h2kd&quot;
          ]
        }
      }
    ]
  },
  &quot;unknown&quot;: {
  },
  &quot;inputs&quot;: [
    {
      &quot;witness_utxo&quot;: {
        &quot;amount&quot;: 0.00000840,
        &quot;scriptPubKey&quot;: {
          &quot;asm&quot;: &quot;0 d591091b8074a2375ed9985a9c4b18efecfd4165&quot;,
          &quot;hex&quot;: &quot;0014d591091b8074a2375ed9985a9c4b18efecfd4165&quot;,
          &quot;type&quot;: &quot;witness_v0_keyhash&quot;,
          &quot;address&quot;: &quot;tb1q6kgsjxuqwj3rwhkenpdfcjccalk06st9z0k0kh&quot;
        }
      },
      &quot;bip32_derivs&quot;: [
        {
          &quot;pubkey&quot;: &quot;02883bb5463e37d55252d8b3d5c2141b007b37c8a7db6211f75c955acc5ea325eb&quot;,
          &quot;master_fingerprint&quot;: &quot;d6043800&quot;,
          &quot;path&quot;: &quot;m/0&#39;/1&#39;/12&#39;&quot;
        }
      ]
    },
    {
      &quot;non_witness_utxo&quot;: {
        &quot;txid&quot;: &quot;68e1863492802df9337e6ce4f89f53fa5739837ba459ba52c9a3d200ab0717ee&quot;,
        &quot;hash&quot;: &quot;68e1863492802df9337e6ce4f89f53fa5739837ba459ba52c9a3d200ab0717ee&quot;,
        &quot;version&quot;: 2,
        &quot;size&quot;: 140,
        &quot;vsize&quot;: 140,
        &quot;weight&quot;: 560,
        &quot;locktime&quot;: 1774654,
        &quot;vin&quot;: [
          {
            &quot;txid&quot;: &quot;cc49eb0b550fc2dc7e3b9fff459f12650e0903fc7b40a31ede670612f9b266d5&quot;,
            &quot;vout&quot;: 1,
            &quot;scriptSig&quot;: {
              &quot;asm&quot;: &quot;0014731714497c53e5f0527a4b18c0273cb798200c5d&quot;,
              &quot;hex&quot;: &quot;160014731714497c53e5f0527a4b18c0273cb798200c5d&quot;
            },
            &quot;sequence&quot;: 4294967294
          }
        ],
        &quot;vout&quot;: [
          {
            &quot;value&quot;: 0.01000000,
            &quot;n&quot;: 0,
            &quot;scriptPubKey&quot;: {
              &quot;asm&quot;: &quot;OP_DUP OP_HASH160 7f437379bcc66c40745edc1891ea6b3830e1975d OP_EQUALVERIFY OP_CHECKSIG&quot;,
              &quot;hex&quot;: &quot;76a9147f437379bcc66c40745edc1891ea6b3830e1975d88ac&quot;,
              &quot;reqSigs&quot;: 1,
              &quot;type&quot;: &quot;pubkeyhash&quot;,
              &quot;addresses&quot;: [
                &quot;ms7ruzvL4atCu77n47dStMb3of6iScS8kZ&quot;
              ]
            }
          },
          {
            &quot;value&quot;: 0.02961601,
            &quot;n&quot;: 1,
            &quot;scriptPubKey&quot;: {
              &quot;asm&quot;: &quot;OP_HASH160 fddfa4317e978a3983fa359d52b2d99495271f68 OP_EQUAL&quot;,
              &quot;hex&quot;: &quot;a914fddfa4317e978a3983fa359d52b2d99495271f6887&quot;,
              &quot;reqSigs&quot;: 1,
              &quot;type&quot;: &quot;scripthash&quot;,
              &quot;addresses&quot;: [
                &quot;2NGParh82hE2Zif5PVK3AfLpYhfwF5FyRGr&quot;
              ]
            }
          }
        ]
      },
      &quot;bip32_derivs&quot;: [
        {
          &quot;pubkey&quot;: &quot;03efdee34c0009fd175f3b20b5e5a5517fd5d16746f2e635b44617adafeaebc388&quot;,
          &quot;master_fingerprint&quot;: &quot;d6043800&quot;,
          &quot;path&quot;: &quot;m/0&#39;/0&#39;/18&#39;&quot;
        }
      ]
    }
  ],
  &quot;outputs&quot;: [
    {
      &quot;bip32_derivs&quot;: [
        {
          &quot;pubkey&quot;: &quot;029bb586a52657dd98852cecef78552a4e21d081a7a30e4008ce9b419840d4deac&quot;,
          &quot;master_fingerprint&quot;: &quot;d6043800&quot;,
          &quot;path&quot;: &quot;m/0&#39;/1&#39;/27&#39;&quot;
        }
      ]
    },
    {
    }
  ],
  &quot;fee&quot;: 0.00028800
}</code></pre>
<p>As you can see it Created the PSBT, and then Updated it with all the
information it could find locally.</p>
<p>From there, you need to use <code>walletprocesspsbt</code> to
Finalize, as usual:</p>
<pre><code>$ psbt_new_f=$(bitcoin-cli walletprocesspsbt $psbt_new | jq -r &#39;.psbt&#39;)</code></pre>
<p>Afterward, an analysis will show it’s about ready to go too:</p>
<pre><code>$ bitcoin-cli analyzepsbt $psbt_new_f
{
  &quot;inputs&quot;: [
    {
      &quot;has_utxo&quot;: true,
      &quot;is_final&quot;: true,
      &quot;next&quot;: &quot;extractor&quot;
    },
    {
      &quot;has_utxo&quot;: true,
      &quot;is_final&quot;: true,
      &quot;next&quot;: &quot;extractor&quot;
    }
  ],
  &quot;estimated_vsize&quot;: 288,
  &quot;estimated_feerate&quot;: 0.00100000,
  &quot;fee&quot;: 0.00028800,
  &quot;next&quot;: &quot;extractor&quot;
}</code></pre>
<p>Now would you really want to use <code>walletcreatefundedpsbt</code>
if you were creating a <code>bitcoin-cli</code> program? Probably not.
But it’s the same analysis as whether to use
<code>fundrawtransaction</code>. Do you let Bitcoin Core do the analysis
and calculation and decisions, or do you take that on yourself?</p>
<h2 id="send-a-psbt">Send a PSBT</h2>
<h4 id="psbt-role-extractor">PSBT Role: Extractor</h4>
<p>To finalize the PSBT, you use <code>finalizepsbt</code>, which will
turn your PSBT back into hex. (It’ll also take on the Finalizer role, if
that didn’t happen already.)</p>
<pre><code>$ bitcoin-cli finalizepsbt $psbt_f
{
  &quot;hex&quot;: &quot;020000000001021b95a6055174ec64b82ef05b6aefc38f34d0e57197e40281ecd8287b4260dec60100000000ffffffff1cf4c7f70160c9fe22436c70e032033fcb7d22309e3d60e386a82cf1f5ef48870000000000ffffffff018a02000000000000160014c772d6f95542e11ef11e8efc7c7a69830ad38a050247304402200a896f1cfa741ccda5f683bb85d95dbf836c390cdd45a785ece1f54766795821022051c4c956da8d3012da61b5465158888939a1ad5dfb106c1e25a2f92f13879122012102bac3a645fd7a0a537c627ad37f5f695058c58d19ceb0033e913f1a9975e00dee0247304402207eb0d3423b8c62150f83a0756baaa93dc8cd15e07f594b2131c753d6ed16e3b2022051e5a44372fb680bf5c487bb87ef0f65bf040ac5e0d54cdbb4f5bcc1ddaac745012102883bb5463e37d55252d8b3d5c2141b007b37c8a7db6211f75c955acc5ea325eb00000000&quot;,
  &quot;complete&quot;: true
}</code></pre>
<p>As usual you’ll want to save that and then you can send it out</p>
<pre><code>$ psbt_hex=$(bitcoin-cli finalizepsbt $psbt_f | jq -r &#39;.hex&#39;)
$ bitcoin-cli -named sendrawtransaction hexstring=$psbt_hex
ea73a631b456d2b041ed73bf5767946408c6ff067716929a68ecda2e3e4de6d3</code></pre>
<h2 id="review-the-workflow">Review the Workflow</h2>
<p>When creating <code>bitcoin-cli</code> software, it’s most likely
that you’ll fulfill the five core roles of PSBTs with
<code>createpsbt</code>, <code>walletprocesspsbt</code>, and
<code>finalizepsbt</code>. Here’s what that flow looks like:</p>
<p><img src="images/psbt-roles-for-cli-1.png" /></p>
<p>If you choose to use the shortcut of
<code>walletcreatefundedpsbt</code>, this is what it looks like
instead:</p>
<p><img src="images/psbt-roles-for-cli-2.png" /></p>
<p>Finally, if you instead need more control and choose to use
<code>utxoupdatepsbt</code> (which is largely undocumented here), you
instead have this workflow:</p>
<p><img src="images/psbt-roles-for-cli-3.png" /></p>
<h2
id="summary-creating-a-partially-signed-bitcoin-transaction">Summary:
Creating a Partially Signed Bitcoin Transaction</h2>
<p>Creating a PSBT involves a somewhat complex workflow of Creating,
Updating, Signing, Finalizing, and Extracting a PSBT, after which it
converts back into a raw transaction. Why would you go to all that
trouble? Because you want to collaborate between multiple users or
multiple programs. Now that you understand this workflow, the next
section has some real-life examples of doing so.</p>
<h2 id="whats-next">What’s Next?</h2>
<p>Continue “Expanding Bitcoin Transactions with PSBTs” with <a
href="07_2_Using_a_Partially_Signed_Bitcoin_Transaction.md">§7.2: Using
a Partially Signed Bitcoin Transaction</a>.</p>
</body>
</html>
